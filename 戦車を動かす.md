# 戦車を動かす

## 配線

<img src='https://raw.githubusercontent.com/libertyfish-co/ruby-hw/images/panzer_vor_1.png' alt='戦車 回路図1' width="400" />
<img src='https://raw.githubusercontent.com/libertyfish-co/ruby-hw/images/panzer_vor_2.png' alt='戦車 回路図2' width="400" />

## 動作確認用のコード

### Gemfile

```ruby
source "https://rubygems.org"

git_source(:github) {|repo_name| "https://github.com/#{repo_name}" }

gem 'pi_piper'
gem 'spi'
gem 'parallel'
```


### ta7291p.rb

モータードライバー(TA7291P) を制御するコードです。

```ruby
require 'pi_piper'

class Ta7291p
  attr_reader :forward_pin, :back_pin

  def initialize(pwm_pin_id, forward_pin_id, back_pin_id, power_value = 0.5)
    @pwm_pin = pwm = PiPiper::Pwm.new pin: pwm_pin_id
    @forward_pin = PiPiper::Pin.new pin: forward_pin_id, direction: :out
    @back_pin = PiPiper::Pin.new pin: back_pin_id, direction: :out
    @power = power_value
    @pwm_pin.value = power_value
  end

  def power=(value)
    @power = value
    @pwm_pin.value = value
  end

  def power
    @power
  end

  def forward(drive_time)
    @forward_pin.on
    sleep drive_time
    @forward_pin.off
  end

  def back(drive_time)
    @back_pin.on
    sleep drive_time
    @back_pin.off
  end

  def breake
    @forward_pin.on
    @back_pin.on
  end
end
```

### mcp3008.rb

アナログ・デジタル変換き(MCP3008) を制御するコードです。

```ruby
require 'pi_piper'

class Mcp3008
  attr_reader :channel

  def initialize(channel)
    @channel = channel
  end

  def read
    PiPiper::Spi.begin do |spi|
      adc = spi.write [0x1, (0x8 + @channel) << 4, 0x0]
      ((adc[1] & 0x3) << 8) + adc[2]
    end
  end
end
```

### gp2y0a21yk0f.rb

距離センサー(GP2Y0A21YK0F) から MCP3008 経由で取得した電圧から距離に変換するコードです。

```ruby
class Gp2y0a21yk0f
  def self.volt_to_distance(volt)
    return 0 if volt == 0

    dist = (6787 / (volt - 3)) - 4
    dist.round(4)
  end
end
```

### panzer_test.rb

動作確認用のコードです。

```ruby
require './ta7291p'
require './mcp3008'
require './gp2y0a21yk0f'

def motor_1
  # GPIO 20 -> 正転?
  # GPIO 21 -> 逆転?
  # GPIO 12 -> PWM
  motor_1 = Ta7291p.new(12, 20, 21, 0.7)
  motor_1.forward(2)
end

def motor_2
  # GPIO 5 -> 正転?
  # GPIO 6 -> 逆転?
  # GPIO 13 -> PWM
  motor_2 = Ta7291p.new(13, 5, 6, 0.7)
  motor_2.forward(2)
end

def distance
  mcp3008 = Mcp3008.new(0)
  Gp2y0a21yk0f.volt_to_distance(mcp3008.read)
end

motor_1
motor_2
puts distance
```
